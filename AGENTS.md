# AGENTS.md (Anti-Power Project Key Context)

English | [中文](AGENTS_ZH.md)

> Goal: Let AI quickly understand what this project does, how patches are applied, and where key entry points are.

## Project Positioning

- Anti-Power is an enhancement patch for Antigravity AI IDE.
- Main enhancements for sidebar dialog area and Manager window: Mermaid rendering, math formula rendering, one-click copy, table color fix, font size control, etc.
- Sidebar patch supports both entries and auto-switches by `product.json.ideVersion`:
  - Legacy (< 1.18.3): `extensions/antigravity/cascade-panel.html` + `cascade-panel/`
  - Modern (>= 1.18.3): `out/vs/code/electron-browser/workbench/workbench.html` + `sidebar-panel/`
- Supports Windows/macOS/Linux; on macOS/Linux you can use installer builds or `patcher/patches/anti-power.sh` (see `README.md` / `patcher/patches/manual-install.md`).
- On macOS/Linux, installer may request privileged escalation (sudo/pkexec) to patch files under `resources/app`.

## Patch Deployment Flow (Core Chain)

1. Desktop installer located at `patcher/` (Tauri + Vue).
2. Rust backend handles: path detection, install/uninstall, config update (`patcher/src-tauri/src/commands/*.rs`).
3. During installation:
   - Backup sidebar + Manager entry files as `.bak` (based on variant):
     - Legacy sidebar: `resources/app/extensions/antigravity/cascade-panel.html`
     - Modern sidebar: `resources/app/out/vs/code/electron-browser/workbench/workbench.html`
     - Manager: `resources/app/out/vs/code/electron-browser/workbench/workbench-jetski-agent.html`
   - Write patch files and directories:
     - Sidebar (legacy): `cascade-panel.html` + `cascade-panel/`
     - Sidebar (modern): `workbench.html` + `sidebar-panel/`
     - `workbench-jetski-agent.html` + `manager-panel/`
   - Generate config files (feature toggles):
     - Sidebar config path is variant-dependent (`cascade-panel/config.json` or `sidebar-panel/config.json`)
     - `manager-panel/config.json`
   - If Manager patch is enabled, remove related checksums from `resources/app/product.json` to avoid the "installation appears corrupted" prompt.
4. Patch files sourced from `patcher/patches/`, embed manifest auto-generated by `patcher/src-tauri/build.rs` (exclude list `patcher/patches/.embed-exclude.txt`), `patcher/src-tauri/src/embedded.rs` includes manifest via `include!`.

## Key Directories (Modification Priority)

- `patcher/patches/`: Patch source files injected into Antigravity (HTML/JS/CSS).
- `patcher/src-tauri/`: Installer backend logic (path detection, backup/write, config).
- `patcher/src/`: Installer frontend UI (feature toggles, install/uninstall buttons).
- `.github/workflows/`: Build/release pipeline (notably macOS Universal build artifacts).
- `docs/`: Development, release, structure, known issues and screenshots (see `docs/README.md`).
- `docs/guides/developer-guide_EN.md`: Comprehensive developer documentation (English) with DOM structure, code conventions, and development workflow.
- `tests/scripts/`: Playwright scripts for remote debugging Antigravity Manager window DOM.
- `patcher/patches/manual-install.md`: Manual installation instructions bundled with patch zip (Windows/macOS/Linux).
- `patcher/patches/workbench.html` + `patcher/patches/sidebar-panel/`: Modern sidebar entry patch and modules.
- `patcher/patches/workbench-jetski-agent.html` + `patcher/patches/manager-panel/`: Manager window patch entry and modules.

## Antigravity Internal Hook Points

- Sidebar (legacy): `resources/app/extensions/antigravity/cascade-panel.html`
- Sidebar (modern): `resources/app/out/vs/code/electron-browser/workbench/workbench.html`
- Manager window: `resources/app/out/vs/code/electron-browser/workbench/workbench-jetski-agent.html`
- ~~Note: Modifying `workbench-jetski-agent.html` triggers "Extension corrupted" prompt~~ (Fixed in v2.3.2+)

## Runtime Logic Overview (Sidebar Patch)

- Legacy entry: `patcher/patches/cascade-panel.html` -> `cascade-panel/cascade-panel.js`
- Modern entry: `patcher/patches/workbench.html` -> `sidebar-panel/sidebar-panel.js`
- Both sidebar modules read `config.json`, load modules on demand and start scanning.
- `scan.js` triggers rendering and copy button injection based on DOM monitoring and content stability detection.

## Build and Release (Installer)

- In `patcher/`:
  - `npm run tauri:dev`
  - `npm run tauri:build`
- Before release, sync version numbers: `patcher/package.json`, `patcher/src-tauri/tauri.conf.json`, `patcher/src-tauri/Cargo.toml`, `patcher/src/App.vue`, `README.md` (see `docs/guides/release-guide.md`).

## Important Constraints/Risks

- Embed manifest auto-generated by build.rs; when adding/removing patch files, check if `.embed-exclude.txt` needs update (e.g., `config.json`, docs).
- Installation logic uses whitelist by mode:
  - Sidebar legacy: `cascade-panel.html` + `cascade-panel/`
  - Sidebar modern: `workbench.html` + `sidebar-panel/`
  - Manager: `workbench-jetski-agent.html` + `manager-panel/`
- Manager patch modifies `resources/app/product.json` checksums; if you patch additional core files, you may need to extend the checksum cleanup list in `patcher/src-tauri/src/commands/patch.rs`.
- Antigravity official updates will overwrite patches, requiring reinstallation.
- Known issue: LaTeX formulas containing `|` in tables render incorrectly (see `docs/reference/known-issues.md`).

## Development Notes (Tools/Environment)

- Documentation uses English punctuation uniformly (both Chinese and English content use English punctuation) to avoid tool processing issues with Chinese punctuation.
- `apply_patch` may trigger `byte index ... is not a char boundary` with long Chinese content, causing patch failure.
  - Solution: Use elevated PowerShell `Set-Content -Encoding UTF8` to write directly, or write ASCII first then append in segments.
- Writing to `patcher/patches/` or cleaning `tests/` may get `Access denied` in sandbox, need elevated commands for write/delete.

## Recent Changes (v2.3.1 - v3.2.1)

- Cross-platform support (macOS/Linux) + path normalization/detection; Unix privileged install flow (sudo/pkexec)
- macOS Universal Build artifacts in release pipeline
- Manager patch avoids corrupted prompt by cleaning `product.json` checksums
- Sidebar patch now supports legacy/modern split and auto-switches by `ideVersion`
- KaTeX CSS and JS parallel loading; copy button customization and layout tweaks
- Better Markdown copy: nested lists + code fences, inline code, SVG filtering, empty-line cleanup
- LaTeX/Mermaid rendering flow strengthened: retry after load failures, streaming re-render support, and reduced Mermaid debug logs
- Privileged install and Unix clean script now use unique temp paths with automatic cleanup; restore flow removes stale `.bak` backups
